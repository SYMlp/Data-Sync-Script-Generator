# 批量导入助手设计方案

**日期**: 2025-12-07
**状态**: Draft

## 1. 需求背景
用户需要将 Excel 中的用户数据导入到现有系统中。由于 Excel 表结构与系统用户表结构不一致，且系统缺乏批量导入接口，因此需要一个辅助工具来完成数据清洗、映射和导入工作。

## 2. 核心功能
在 Streamlit 前端新增 "批量导入助手" Tab 页，包含以下步骤：

### 2.1 源数据处理 (Source)
- **上传**: 支持 .xlsx/.xls 文件上传。
- **解析**: 使用 Pandas 读取 Excel。
- **预览**: 展示前几行数据，让用户确认格式。
- **持久化**: 考虑到数据量小 (<100条)，直接缓存在 Streamlit Session State 中即可，无需额外文件存储。

### 2.2 目标数据分析 (Target)
- **连接**: 复用现有的数据库连接配置。
- **选择**: 用户选择目标表（如 `t_user`）。
- **分析**: 获取目标表的字段列表、类型。

### 2.3 字段映射 (Mapping)
- **界面**: 动态生成映射表单。
  - 行：目标数据库字段
  - 列：下拉选择框，列出 Excel 中的所有表头。
- **逻辑**: 支持 "固定值" 或 "Excel 列" 两种映射方式（进阶功能）。初步先实现 "Excel 列" 映射。

### 2.4 执行与输出 (Execution)

#### 模式 A: 生成 SQL
- 根据映射关系，遍历 Excel 数据行。
- 生成 `INSERT INTO target_table (col1, col2) VALUES (val1, val2);`
- 提供 SQL 文本下载或直接复制。

#### 模式 B: API 批量调用
- **配置**:
  - API URL: `http://api.example.com/users`
  - Method: POST/PUT
  - Headers: JSON 编辑区
  - Body 模板: JSON 编辑区，支持占位符 `{{Excel表头名}}`。
- **预览**: 根据第一行数据渲染请求体预览。
- **执行**: 批量发送请求，实时显示进度条和成功/失败日志。

## 3. 技术实现

### 3.1 依赖库
- `pandas`, `openpyxl`: 处理 Excel。
- `requests`: 发送 API 请求。

### 3.2 模块结构
- `streamlit_app.py`: 主入口，增加 Tab。
- `src/services/import_service.py` (新增): 处理映射逻辑和生成逻辑。
- `src/utils/excel_loader.py` (新增): Excel 读取封装。

## 4. 数据流
Excel -> DataFrame -> Mapping Config -> List[Dict] (Mapped Data) -> SQL String / API Requests

